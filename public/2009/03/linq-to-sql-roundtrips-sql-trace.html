<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>LINQ to SQL Roundtrips: SQL Trace | Hugo Quick Start Site</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="description" content="I was looking into reducing the number of database round trips that LINQ to SQL took and found an article by David Hayden that fit the bill. I wanted to see what was actually happening so I slapped together a simple demo.
Using the Pubs database I created a console app, added the LINQ to SQL classes then created a simple repository class:
public class AuthorRepository { public author GetAuthorWithTitles(string authorId) { var db = new PubsDataClassesDataContext(); return db.">
    <meta name="generator" content="Hugo 0.121.2">
    
    
    
    
      <meta name="robots" content="noindex, nofollow">
    

    
<link rel="stylesheet" href="/ananke/css/main.min.css" >



    

    
      

    

    

    
      <link rel="canonical" href="https://example.org/2009/03/linq-to-sql-roundtrips-sql-trace.html">
    

    <meta property="og:title" content="LINQ to SQL Roundtrips: SQL Trace" />
<meta property="og:description" content="I was looking into reducing the number of database round trips that LINQ to SQL took and found an article by David Hayden that fit the bill. I wanted to see what was actually happening so I slapped together a simple demo.
Using the Pubs database I created a console app, added the LINQ to SQL classes then created a simple repository class:
public class AuthorRepository { public author GetAuthorWithTitles(string authorId) { var db = new PubsDataClassesDataContext(); return db." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://example.org/2009/03/linq-to-sql-roundtrips-sql-trace.html" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2009-03-27T12:13:00-07:00" />
<meta property="article:modified_time" content="2009-03-27T12:13:00-07:00" />

<meta itemprop="name" content="LINQ to SQL Roundtrips: SQL Trace">
<meta itemprop="description" content="I was looking into reducing the number of database round trips that LINQ to SQL took and found an article by David Hayden that fit the bill. I wanted to see what was actually happening so I slapped together a simple demo.
Using the Pubs database I created a console app, added the LINQ to SQL classes then created a simple repository class:
public class AuthorRepository { public author GetAuthorWithTitles(string authorId) { var db = new PubsDataClassesDataContext(); return db."><meta itemprop="datePublished" content="2009-03-27T12:13:00-07:00" />
<meta itemprop="dateModified" content="2009-03-27T12:13:00-07:00" />
<meta itemprop="wordCount" content="825">
<meta itemprop="keywords" content=".Net,SQL Origami," /><meta name="twitter:card" content="summary"/><meta name="twitter:title" content="LINQ to SQL Roundtrips: SQL Trace"/>
<meta name="twitter:description" content="I was looking into reducing the number of database round trips that LINQ to SQL took and found an article by David Hayden that fit the bill. I wanted to see what was actually happening so I slapped together a simple demo.
Using the Pubs database I created a console app, added the LINQ to SQL classes then created a simple repository class:
public class AuthorRepository { public author GetAuthorWithTitles(string authorId) { var db = new PubsDataClassesDataContext(); return db."/>

	
  </head>

  <body class="ma0 avenir bg-near-white">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="/" class="f3 fw2 hover-white no-underline white-90 dib">
      
        Hugo Quick Start Site
      
    </a>
    <div class="flex-l items-center">
      

      
      
<div class="ananke-socials">
  
</div>

    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3">
    <header class="mt4 w-100">
      <aside class="instapaper_ignoref b helvetica tracked ttu">
          
        Posts
      </aside>
      










  <div id="sharing" class="mt3 ananke-socials">
    
  </div>


      <h1 class="f1 athelas mt3 mb1">LINQ to SQL Roundtrips: SQL Trace</h1>
      
      
      
      <time class="f6 mv4 dib tracked" datetime="2009-03-27T12:13:00-07:00">March 27, 2009</time>
      

      
      
    </header>
    <div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l"><p>I was looking into reducing the number of database round trips that LINQ to SQL took and found an article by <a href="http://davidhayden.com/blog/dave/archive/2007/08/05/LINQToSQLPerformanceTradeoffsLessDatabaseRoundtripsButDuplicatedData.aspx" title="David Hayden">David Hayden</a> that fit the bill. I wanted to see what was actually happening so I slapped together a simple demo.</p>
<p>Using the Pubs database I created a console app, added the LINQ to SQL classes then created a simple repository class:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AuthorRepository</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">public</span> author GetAuthorWithTitles(<span style="color:#66d9ef">string</span> authorId)
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">var</span> db = <span style="color:#66d9ef">new</span> PubsDataClassesDataContext();
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> db.authors.FirstOrDefault(a =&gt; a.au_id == authorId);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">public</span> author GetAuthorWithTitlesWithUsing(<span style="color:#66d9ef">string</span> authorId)
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">using</span> (<span style="color:#66d9ef">var</span> db = <span style="color:#66d9ef">new</span> PubsDataClassesDataContext())
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> db.authors.FirstOrDefault(a =&gt; a.au_id == authorId);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">public</span> author GetAuthorWithTitlesPrefetch(<span style="color:#66d9ef">string</span> authorId)
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">using</span> (<span style="color:#66d9ef">var</span> db = <span style="color:#66d9ef">new</span> PubsDataClassesDataContext())
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                  <span style="color:#66d9ef">var</span> options = <span style="color:#66d9ef">new</span> DataLoadOptions();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                  options.LoadWith&lt;author&gt;(a =&gt; a.titleauthors);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                  options.LoadWith&lt;titleauthor&gt;(ta =&gt; ta.title);
</span></span><span style="display:flex;"><span>                  db.LoadOptions = options;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                  <span style="color:#66d9ef">return</span> db.authors.FirstOrDefault(a =&gt; a.au_id == authorId);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>I created a simple method to dump the author and titles:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Program</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> Main(<span style="color:#66d9ef">string</span>[] args)
</span></span><span style="display:flex;"><span>     {
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">var</span> repo = <span style="color:#66d9ef">new</span> AuthorRepository();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>          DumpAuthorToConsole(
</span></span><span style="display:flex;"><span>               repo.GetAuthorWithTitles(<span style="color:#e6db74">&#34;998-72-3567&#34;</span>)
</span></span><span style="display:flex;"><span>               , <span style="color:#e6db74">&#34;Authors without prefetch and without using statement&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>          DumpAuthorToConsole(
</span></span><span style="display:flex;"><span>               repo.GetAuthorWithTitlesWithUsing(<span style="color:#e6db74">&#34;998-72-3567&#34;</span>)
</span></span><span style="display:flex;"><span>               , <span style="color:#e6db74">&#34;Authors without prefetch and but with using statement&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>          DumpAuthorToConsole(
</span></span><span style="display:flex;"><span>               repo.GetAuthorWithTitlesPrefetch(<span style="color:#e6db74">&#34;998-72-3567&#34;</span>)
</span></span><span style="display:flex;"><span>          , <span style="color:#e6db74">&#34;Authors with prefetch and with using statement&#34;</span>);
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> DumpAuthorToConsole(author author, <span style="color:#66d9ef">string</span> message)
</span></span><span style="display:flex;"><span>     {
</span></span><span style="display:flex;"><span>          Console.WriteLine();
</span></span><span style="display:flex;"><span>          Console.WriteLine(<span style="color:#66d9ef">new</span> <span style="color:#66d9ef">string</span>(<span style="color:#e6db74">&#39;-&#39;</span>, <span style="color:#ae81ff">50</span>));
</span></span><span style="display:flex;"><span>          Console.WriteLine(message);
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">try</span>
</span></span><span style="display:flex;"><span>          {
</span></span><span style="display:flex;"><span>               Console.WriteLine(<span style="color:#e6db74">&#34;Author Name: { 0}{ 1}&#34;</span>
</span></span><span style="display:flex;"><span>                                    , author.au_fname, author.au_lname);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>               Console.WriteLine(<span style="color:#e6db74">&#34;Count of Titles: { 0}&#34;</span>, author.titleauthors.Count);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>               <span style="color:#66d9ef">foreach</span> (<span style="color:#66d9ef">var</span> titleauthor <span style="color:#66d9ef">in</span> author.titleauthors)
</span></span><span style="display:flex;"><span>                    Console.WriteLine(<span style="color:#e6db74">&#34;tBook Title: {0}&#34;</span>, titleauthor.title.title1);
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">catch</span> (Exception e)
</span></span><span style="display:flex;"><span>          {
</span></span><span style="display:flex;"><span>               Console.WriteLine(<span style="color:#e6db74">&#34;&gt;&gt;&gt; FAIL!&lt;&lt;&lt; &#34;</span>);
</span></span><span style="display:flex;"><span>               Console.WriteLine(e.Message);
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>     }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>I did cheat and added some titles to the chosen author just so I could have at least five titles returned. The results are:</p>
<pre tabindex="0"><code>Authors without prefetch and without using statement
Author Name: Albert Ringer
Count of Titles: 5
Book Title: Silicon Valley Gastronomic Treats
Book Title: Secrets of Silicon Valley
Book Title: Computer Phobic AND Non-Phobic Individuals: Behavior Variations
Book Title: Is Anger the Enemy?
Book Title: Life Without Fear
</code></pre><pre tabindex="0"><code>Authors without prefetch and but with using statement
Author Name: Albert Ringer
&gt;&gt;&gt; FAIL! &lt;&lt;&lt;
Cannot access a disposed object.
Object name: &#39;DataContext accessed after Dispose.&#39;.
</code></pre><pre tabindex="0"><code>Authors with prefetch and with using statement
Author Name: Albert Ringer
Count of Titles: 5
Book Title: Silicon Valley Gastronomic Treats
Book Title: Secrets of Silicon Valley
Book Title: Computer Phobic AND Non-Phobic Individuals: Behavior Variations
Book Title: Is Anger the Enemy?
Book Title: Life Without Fear
Press any key to continue . . .
</code></pre><p>Notice that there are three cases above, with one failing.</p>
<h2 id="what-are-we-looking-at">What are we looking at?</h2>
<h3 id="case-1-authors-without-prefetch-and-without-using-statement">Case 1: Authors without prefetch and without using statement</h3>
<p>This is the GetAuthorsWithTitles() method, it simple creates the DataContext and returns the author object. Simple, clean and easy, but not very effecient.</p>
<p>First note that the DataContext was not disposed so it is still lingering out there, waiting to be garbage collected. The SQL trace looks like this:</p>
<p><a href="/assets/techshorts/case01.png"><img src="/assets/techshorts/case01.png" alt=""></a></p>
<p>The first sp_executesql loads the author, the second loads all the titleauthor rows for the author and the rest select each individual title from the titles table. So for one author, a count of his titles and a list of each title requiers seven round trips to the database. Notice that each time a round trip is made a connection has to be created.</p>
<h3 id="case-2-authors-without-prefetch-and-but-with-using-statement">Case 2: Authors without prefetch and but with using statement</h3>
<p>This is the GetAuthorsWithTitleWithUsing() method, which is the same as before in that it simple creates a DataContext and returns the author but then properly disposes of the context. This fails to return the count of the titles and the individual titles because the lazy loading cannot happen on a disposed context so an exception is thrown in this case.</p>
<p>The trace only shows one sp_executesql:
<a href="/assets/techshorts/case02.png"><img src="/assets/techshorts/case02.png" alt=""></a></p>
<h3 id="case-3-authors-with-prefetch-and-with-using-statement">Case 3: Authors with prefetch and with using statement</h3>
<p>In this case we use the DataL\oadOptions to tell LINQ to load the titleauthors with the author and to load the titles with the titleauthors. The DataContext is disposed after returning the author.</p>
<p><a href="/assets/techshorts/case03.png"><img src="/assets/techshorts/case03.png" alt=""></a></p>
<p>Notice that two sp_executesql&rsquo;s were executed and that both were on the same connection. The first sql returned the author:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">exec</span> sp_executesql
</span></span><span style="display:flex;"><span>    N<span style="color:#e6db74">&#39;SELECT TOP (1) [t0].[au_id]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        , [t0].[au_lname]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        , [t0].[au_fname]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        , [t0].[phone]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        , [t0].[address]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        , [t0].[city]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        , [t0].[state]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        , [t0].[zip]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        , [t0].[contract]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    FROM [dbo].[authors] AS [t0]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    WHERE [t0].[au_id] = @p0&#39;</span>
</span></span><span style="display:flex;"><span>    ,N<span style="color:#e6db74">&#39;@p0 varchar(11)&#39;</span>,<span style="color:#f92672">@</span>p0<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;998-72-3567&#39;</span>
</span></span></code></pre></div><p>the second returned the titleauthor and titles:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">exec</span> sp_executesql
</span></span><span style="display:flex;"><span>     N<span style="color:#e6db74">&#39;SELECT [t0].[au_id]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          , [t0].[title_id]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          , [t0].[au_ord]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          , [t0].[royaltyper]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          , [t1].[title_id] AS [title_id2]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          , [t1].[title] AS [title1]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          , [t1].[type]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          , [t1].[pub_id]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          , [t1].[price]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          , [t1].[advance]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          , [t1].[royalty]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          , [t1].[ytd_sales]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          , [t1].[notes]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          , [t1].[pubdate]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     FROM [dbo].[titleauthor] AS [t0]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          INNER JOIN [dbo].[titles] AS [t1] ON [t1].[title_id] = [t0].[title_id]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     WHERE [t0].[au_id] = @x1&#39;</span>,
</span></span><span style="display:flex;"><span>     N<span style="color:#e6db74">&#39;@x1 varchar(11)&#39;</span>,<span style="color:#f92672">@</span>x1<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;998-72-3567&#39;</span>
</span></span></code></pre></div><h2 id="lessons-learned">Lessons Learned</h2>
<p>First beware of disposing the DataContext when you want to LazyLoad entities. If you are going to do this then come up with a way to properly dispose of the context.</p>
<p>Second round trips to the database can be reduced by using the DataLoadOptions. This is not a guaranty of better performance but it is a step in the right direction.</p>
<ul class="pa0">
  
   <li class="list di">
     <a href="/tags/.net/" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">.Net</a>
   </li>
  
   <li class="list di">
     <a href="/tags/sql-origami/" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">SQL Origami</a>
   </li>
  
</ul>
<div class="mt6 instapaper_ignoref">
      
      
      </div>
    </div>

    <aside class="w-30-l mt6-l">




  <div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links">
    <p class="f5 b mb3">Related</p>
    <ul class="pa0 list">
	   
	     <li  class="mb2">
          <a href="/2004/01/period-matirx-twisting.html">Period Matirx Twisting</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/2009/03/datatable-finding-differences-in-column.html">DataTable: Finding Differences in Column Values</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/2009/02/dataset-more-reasons-to-not-like-it.html">DataSet: More reasons to not like it</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/2009/01/using-idataerrorinfo-for-validation.html">Using IDataErrorInfo for Validation</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/2008/05/changing-typed-dataset-connection-string.html">Changing Typed DataSet Connection String</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/2008/02/datasets-love-em-hate-em.html">DataSets - Love em Hate em</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/2007/03/learning-typemocknet.html">Learning TypeMock.Net</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/2007/01/david-hayden-mvp-c-validation.html">David Hayden [MVP C#] : Validation Application Block - Integrating It Into Your Business Layer</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/2006/11/what-in-name.html">What&amp;#39;s in a Name?</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/2006/11/switched-back-to-resharper.html">Switched Back to ReSharper</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/2006/10/sql-moment-of-clairity.html">SQL Moment of Clairity</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/2006/08/building-build-server-with-ccnet.html">Building a build server with CC.NET</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/2006/08/reading-net-configuration-files.html">Reading .NET Configuration Files</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/2006/06/resharper-vs-coderush.html">Resharper vs CodeRush</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/2006/04/sqlassist-sql-intellisense.html">SqlAssist, SQL Intellisense</a>
        </li>
	    
    </ul>
</div>

</aside>

  </article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://example.org/" >
    &copy;  Hugo Quick Start Site 2024 
  </a>
    <div>
<div class="ananke-socials">
  
</div>
</div>
  </div>
</footer>

  </body>
</html>
